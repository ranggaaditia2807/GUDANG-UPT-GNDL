<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Gudang Realtime - Multi User</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    h1 { color: #2c3e50; }
    input, button { padding: 8px; margin: 5px 0; }
    ul { list-style: none; padding: 0; }
    li { 
      margin: 5px 0; 
      padding: 8px; 
      background: #ecf0f1; 
      border-radius: 5px;
      display: flex; 
      justify-content: space-between;
      align-items: center;
    }
    .actions button { margin-left: 5px; }
    #app { display: none; }
  </style>
  <script type="module">
    // Import Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { 
      getFirestore, collection, addDoc, onSnapshot, 
      deleteDoc, doc, updateDoc, query, where 
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { 
      getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, 
      onAuthStateChanged, signOut 
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    //For Firebase JS SDK v7.20.0 and later, measurementId is optional
    const firebaseConfig = {
     apiKey: "AIzaSyCet2jx7iS8sAPvJxQ4oMOVI3HmuqUxT_A",
  authDomain: "gudang-upt-gandul.firebaseapp.com",
  projectId: "gudang-upt-gandul",
  storageBucket: "gudang-upt-gandul.firebasestorage.app",
  messagingSenderId: "996000637095",
  appId: "1:996000637095:web:20e513b201889e00963b82",
  measurementId: "G-06W2N5X29B"
    };

    // Init Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let unsubscribe = null; // listener barang

    // Register
    async function register() {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      try {
        await createUserWithEmailAndPassword(auth, email, password);
        alert("Akun berhasil dibuat! Silakan login.");
      } catch (e) {
        alert(e.message);
      }
    }

    // Login
    async function login() {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      try {
        await signInWithEmailAndPassword(auth, email, password);
      } catch (e) {
        alert(e.message);
      }
    }

    // Logout
    async function logout() {
      await signOut(auth);
    }

    // Tambah barang
    async function tambahBarang() {
      const nama = document.getElementById("nama").value.trim();
      if (!nama) return alert("Nama barang kosong!");
      const user = auth.currentUser;
      await addDoc(collection(db, "barang"), { nama, uid: user.uid });
      document.getElementById("nama").value = "";
    }

    // Hapus barang
    async function hapusBarang(id) {
      await deleteDoc(doc(db, "barang", id));
    }

    // Edit barang
    async function editBarang(id, namaLama) {
      const namaBaru = prompt("Edit nama barang:", namaLama);
      if (namaBaru && namaBaru.trim() !== "") {
        await updateDoc(doc(db, "barang", id), { nama: namaBaru.trim() });
      }
    }

    // Auth state
    onAuthStateChanged(auth, (user) => {
      const authBox = document.getElementById("auth");
      const appBox = document.getElementById("app");
      if (user) {
        authBox.style.display = "none";
        appBox.style.display = "block";

        // Realtime data hanya untuk user ini
        const q = query(collection(db, "barang"), where("uid", "==", user.uid));
        if (unsubscribe) unsubscribe();
        unsubscribe = onSnapshot(q, (snapshot) => {
          const listEl = document.getElementById("list");
          listEl.innerHTML = "";
          snapshot.forEach(docSnap => {
            const data = docSnap.data();
            const li = document.createElement("li");
            li.innerHTML = `
              <span>${data.nama}</span>
              <span class="actions">
                <button onclick="editBarang('${docSnap.id}', '${data.nama}')">✏️ Edit</button>
                <button onclick="hapusBarang('${docSnap.id}')">🗑️ Hapus</button>
              </span>
            `;
            listEl.appendChild(li);
          });
        });

      } else {
        authBox.style.display = "block";
        appBox.style.display = "none";
      }
    });

    // Expose fungsi
    window.register = register;
    window.login = login;
    window.logout = logout;
    window.tambahBarang = tambahBarang;
    window.hapusBarang = hapusBarang;
    window.editBarang = editBarang;
  </script>
</head>
<body>
  <h1>📦 Gudang Realtime (Multi User)</h1>

  <!-- Box Login/Register -->
  <div id="auth">
    <h3>Login / Register</h3>
    <input type="email" id="email" placeholder="Email"><br>
    <input type="password" id="password" placeholder="Password"><br>
    <button onclick="login()">Login</button>
    <button onclick="register()">Register</button>
  </div>

  <!-- Box Aplikasi -->
  <div id="app">
    <button onclick="logout()">🚪 Logout</button>
    <h3>Tambah Barang</h3>
    <input type="text" id="nama" placeholder="Nama Barang">
    <button onclick="tambahBarang()">Tambah</button>

    <h3>Daftar Barang Anda:</h3>
    <ul id="list"></ul>
  </div>
</body>
</html>


